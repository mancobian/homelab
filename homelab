#!/bin/bash

source ${ROOTDIR}/.env

VERSION=0.0.1

function do_setup() {
    # Copy installation files to the remote server
    rsync -arvzP \
        ${CI_SSH_KEY_PATH}/${CI_PUBLIC_KEY_FILE} \
        ${CI_SSH_KEY_PATH}/${CI_PRIVATE_KEY_FILE} \
        ${ROOTDIR}/.env \
        ${ROOTDIR}/proxmox/cfg/ \
        ${ROOTDIR}/cmd/setup/ \
        ${PROXMOX_USER}@${PROXMOX_HOST}:${SERVER_ROOT_DIR}

    # Execute command on remote server
    ssh ${PROXMOX_USER}@${PROXMOX_HOST} "${SERVER_ROOT_DIR}/setup.sh; rm -rf ${SERVER_ROOT_DIR}"
}

function do_teardown() {
    # Copy installation files to the remote server
    rsync -arvzP \
        ${ROOTDIR}/.env \
        ${ROOTDIR}/proxmox/cfg/ \
        ${ROOTDIR}/cmd/teardown/ \
        ${PROXMOX_USER}@${PROXMOX_HOST}:${SERVER_ROOT_DIR}

    # Execute command on remote server
    ssh ${PROXMOX_USER}@${PROXMOX_HOST} "${SERVER_ROOT_DIR}/teardown.sh; rm -rf ${SERVER_ROOT_DIR}"
}

function print_usage() {
    echo "Homelab v${VERSION}"
    echo "Usage: $(basename "$0") [setup|teardown]" 
    exit 0
}

ARGV=$@
if [ "x$ARGV" = "x" ]; then
    ARGV="-h"
fi

case $ARGV in
setup)
    do_setup
    exit 0
    ;;
teardown)
    do_teardown
    exit 0
    ;;
*)
    print_usage
    ;;
esac
exit 1