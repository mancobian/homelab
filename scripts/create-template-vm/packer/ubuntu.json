{
    "variables": {
      "proxmox_template_name": "ubuntu-20.04",
      "ubuntu_iso_file": "ubuntu-20.04.1-live-server-amd64.iso",
      "proxmox_api_url": "{{env `PROXMOX_API_URL`}}", 
      "proxmox_user": "{{env `PM_USER`}}", 
      "proxmox_password": "{{env `PROXMOX_PASSWORD`}}", 
      "proxmox_node": "{{env `PROXMOX_HOST`}}", 
      "vmid": "{{env `TEMPLATE_VM_ID`}}",
      "ssh_user": "{{env `PACKER_SSH_USER`}}",
      "ssh_password": "{{env `PACKER_SSH_PASSWORD`}}",
      "proxmox_storage_ci": "{{env `PROXMOX_STORAGE_SNIPPETS`}}",
      "proxmox_storage_vm": "{{env `PROXMOX_STORAGE_VM`}}"
    },
    "builders": [{
      "type": "proxmox",
      "proxmox_url": "{{user `proxmox_api_url`}}",
      "username": "{{user `proxmox_user`}}",
      "password": "{{user `proxmox_password`}}",
      "node": "{{user `proxmox_node`}}",
      "insecure_skip_tls_verify": true,
      "cloud_init": true,
      "cloud_init_storage_pool": "{{user `proxmox_storage_ci`}}",
      "vm_id": "{{user `vmid`}}",
      "network_adapters": [{
        "bridge": "vmbr0"
      }],
      "disks": [{
        "type": "scsi",
        "disk_size": "20G",
        "storage_pool": "{{user `proxmox_storage_vm`}}",
        "storage_pool_type": "lvm"
      }],
      "iso_file": "local:iso/{{user `ubuntu_iso_file`}}",
      "unmount_iso": true,
      "boot_wait": "5s",
      "memory": 1024,
      "template_name": "{{user `proxmox_template_name`}}",
      "http_directory": "http",
      "boot_command": [
        "<esc><wait><esc><wait><f6><wait><esc><wait>",
        "<bs><bs><bs><bs><bs>",
        "autoinstall ds=nocloud-net;s=http://{{ .HTTPIP }}:{{ .HTTPPort }}/ ",
        "--- <enter>"
      ],
      "ssh_username": "{{user `ssh_user`}}",
      "ssh_password": "{{user `ssh_password`}}"
    }],
    "provisioners": [{
      "type": "shell",
      "inline": [
        "while [ ! -f /var/lib/cloud/instance/boot-finished ]; do echo 'Waiting for cloud-init...'; sleep 1; done"
      ]
    }]
  }
